# Проект 4-го спринта
## Описание
Необходимо построить витрину, содержащую информацию о выплатах курьерам.

Состав витрины:

- `id` — идентификатор записи.
- `courier_id` — ID курьера, которому перечисляем.
- `courier_name` — Ф. И. О. курьера.
- `settlement_year` — год отчёта.
- `settlement_month` — месяц отчёта, где `1` — январь и `12` — декабрь.
- `orders_count` — количество заказов за период (месяц).
- `orders_total_sum` — общая стоимость заказов.
- `rate_avg` — средний рейтинг курьера по оценкам пользователей.
- `order_processing_fee` — сумма, удержанная компанией за обработку заказов, которая высчитывается как `orders_total_sum * 0.25`.
- `courier_order_sum` — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).
- `courier_tips_sum` — сумма, которую пользователи оставили курьеру в качестве чаевых.
- `courier_reward_sum` — сумма, которую необходимо перечислить курьеру. Вычисляется как `courier_order_sum + courier_tips_sum * 0.95` (5% — комиссия за обработку платежа).

Правила расчёта процента выплаты курьеру в зависимости от рейтинга, где r — это средний рейтинг курьера в расчётном месяце:

- r < 4 — 5% от заказа, но не менее 100 р.;
- 4 <= r < 4.5 — 7% от заказа, но не менее 150 р.;
- 4.5 <= r < 4.9 — 8% от заказа, но не менее 175 р.;
- 4.9 <= r — 10% от заказа, но не менее 200 р.

Данные о заказах уже есть в хранилище. Данные курьерской службы вам необходимо забрать из API курьерской службы, после чего совместить их с данными подсистемы заказов.

Отчёт собирается по дате заказа. Если заказ был сделан ночью и даты заказа и доставки не совпадают, в отчёте стоит ориентироваться на дату заказа, а не дату доставки. Иногда заказы, сделанные ночью до 23:59, доставляют на следующий день: дата заказа и доставки не совпадёт. Это важно, потому что такие случаи могут выпадать в том числе и на последний день месяца. Тогда начисление курьеру относите к дате заказа, а не доставки.

---

## Техническая информация по запуску
Запустите локально команду:

```bash
docker run \
-d \
-p 3000:3000 \
-p 3002:3002 \
-p 15432:5432 \
--mount src=airflow_sp5,target=/opt/airflow \
--mount src=lesson_sp5,target=/lessons \
--mount src=db_sp5,target=/var/lib/postgresql/data \
--name=de-sprint-5-server-local \
cr.yandex/crp1r8pht0n0gl25aug1/de-pg-cr-af:latest
```

После того как запустится контейнер, вам будут доступны:
- Airflow
	- `localhost:3000/airflow`
- БД
	- `jovyan:jovyan@localhost:15432/de`

- Просписать коннект в airflow к локальному postgres Conn Id = 'PG_DWH'
- заполнить в DAG:
    * nickname = ''
    * cohort = ''
    * api_key = ''
    * base_url = ''
---